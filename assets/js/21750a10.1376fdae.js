"use strict";(self.webpackChunkdiscord4j_documentation=self.webpackChunkdiscord4j_documentation||[]).push([[442],{6037:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>d});var n=s(4848),i=s(8453);const t={id:"threading",title:"Threading",sidebar_label:"Threading",slug:"/threading"},c=void 0,o={id:"How-to Guides/threading",title:"Threading",description:"Reactor and threading",source:"@site/docs/04-How-to Guides/threading.mdx",sourceDirName:"04-How-to Guides",slug:"/threading",permalink:"/threading",draft:!1,unlisted:!1,editUrl:"https://github.com/Discord4J/documentation/edit/master/docs/04-How-to Guides/threading.mdx",tags:[],version:"current",lastUpdatedAt:1631899753e3,frontMatter:{id:"threading",title:"Threading",sidebar_label:"Threading",slug:"/threading"},sidebar:"mySidebar",previous:{title:"Sharding",permalink:"/sharding"},next:{title:"Using Snapshots",permalink:"/using-snapshots"}},a={},d=[{value:"Reactor and threading",id:"reactor-and-threading",level:2},{value:"Threading model",id:"threading-model",level:2},{value:"Customization",id:"customization",level:2},{value:"ReactorResources",id:"reactorresources",level:3},{value:"Replacing Schedulers",id:"replacing-schedulers",level:4},{value:"<code>timerTaskScheduler</code>",id:"timertaskscheduler",level:5},{value:"<code>blockingTaskScheduler</code>",id:"blockingtaskscheduler",level:5},{value:"Specific resources for Gateway and Voice",id:"specific-resources-for-gateway-and-voice",level:4},{value:"EventDispatcher",id:"eventdispatcher",level:3},{value:"Replacing thread model",id:"replacing-thread-model",level:4}];function l(e){const r={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h2,{id:"reactor-and-threading",children:"Reactor and threading"}),"\n",(0,n.jsx)(r.admonition,{type:"note",children:(0,n.jsxs)(r.p,{children:["This is an advanced topic and expects you have read the ",(0,n.jsx)(r.strong,{children:"Threading and Schedulers"})," section of the Reactor reference. ",(0,n.jsx)(r.a,{href:"https://projectreactor.io/docs/core/release/reference/#schedulers",children:"Check it out"})," to familiarize yourself with its API and usage."]})}),"\n",(0,n.jsxs)(r.p,{children:["Reactor is a ",(0,n.jsx)(r.strong,{children:"concurrency agnostic runtime"}),", there is no set thread affinity for each operator, leaving users in control on the thread in which operations happen. The framework provides many ",(0,n.jsx)(r.code,{children:"Scheduler"})," implementations and helper methods that materialize that control and are used by Discord4J throughout its modules."]}),"\n",(0,n.jsx)(r.h2,{id:"threading-model",children:"Threading model"}),"\n",(0,n.jsxs)(r.p,{children:["Discord4J sets reasonable defaults on the threading aspect, to cover the most possible use cases without compromising performance. First, since our network runtime is the ",(0,n.jsx)(r.a,{href:"https://github.com/reactor/reactor-netty",children:"Reactor Netty"})," project, every HTTP (API and websocket) and UDP interaction occurs on their default scheduling approach which is providing an ",(0,n.jsx)(r.strong,{children:"event loop"})," using an amount of threads given by the available processors, with a minimum of 4."]}),"\n",(0,n.jsxs)(r.p,{children:["Given that each of the Reactor Netty event loop threads do not allow blocking operations, we use a ",(0,n.jsx)(r.a,{href:"https://github.com/reactor/reactor-addons/blob/master/reactor-extra/src/main/java/reactor/scheduler/forkjoin/ForkJoinPoolScheduler.java",children:"ForkJoinPoolScheduler"})," to dispatch every event (through ",(0,n.jsx)(r.code,{children:"EventDispatcher"})," + ",(0,n.jsx)(r.code,{children:"publishOn"}),")."]}),"\n",(0,n.jsxs)(r.p,{children:["Every HTTP API response is given back to you through the ",(0,n.jsx)(r.strong,{children:"Bounded Elastic Scheduler"}),", that is capable of supporting blocking operations downstream."]}),"\n",(0,n.jsx)(r.p,{children:"Some operations create exclusive Schedulers for serializing calls like emitting permits for rate-limited operations like the GlobalRateLimiter, Gateway IDENTIFY limiter and the per-session outbound limiter."}),"\n",(0,n.jsx)(r.h2,{id:"customization",children:"Customization"}),"\n",(0,n.jsxs)(r.p,{children:["Since Reactor gives the control to its users regarding threading, it is our goal to extend that flexibility to you as well. While you're still under control using operators such as ",(0,n.jsx)(r.a,{href:"https://projectreactor.io/docs/core/release/reference/#_publishon",children:(0,n.jsx)(r.code,{children:"publishOn"})})," and ",(0,n.jsx)(r.a,{href:"https://projectreactor.io/docs/core/release/reference/#_subscribeon",children:(0,n.jsx)(r.code,{children:"subscribeOn"})})," you can also override some defaults we set above."]}),"\n",(0,n.jsx)(r.h3,{id:"reactorresources",children:"ReactorResources"}),"\n",(0,n.jsxs)(r.p,{children:["A new class dedicated to group application-wide resources used by Discord4J was created starting from v3.1.0. ",(0,n.jsx)(r.a,{href:"https://www.javadoc.io/doc/com.discord4j/discord4j-common/latest/discord4j/common/ReactorResources.html",children:"ReactorResources"})," is the place to customize a set of ",(0,n.jsx)(r.code,{children:"Scheduler"})," instances and other Reactor-related resources, including the schedulers used by HTTP/Websocket and UDP clients."]}),"\n",(0,n.jsxs)(r.p,{children:["An instance is created per ",(0,n.jsx)(r.code,{children:"DiscordClient"})," and they can be shared if created externally:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'ReactorResources reactorResources = ReactorResources.builder()\r\n    .timerTaskScheduler(Schedulers.newParallel("my-scheduler"))\r\n    .blockingTaskScheduler(Schedulers.boundedElastic())\r\n    .build();\r\n\r\nDiscordClient discordClient = DiscordClientBuilder.create("TOKEN")\r\n    .setReactorResources(reactorResources)\r\n    .build();\n'})}),"\n",(0,n.jsx)(r.h4,{id:"replacing-schedulers",children:"Replacing Schedulers"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'ReactorResources reactorResources = ReactorResources.builder()\r\n    .timerTaskScheduler(Schedulers.newParallel("my-scheduler"))\r\n    .blockingTaskScheduler(Schedulers.boundedElastic())\r\n    .build();\n'})}),"\n",(0,n.jsx)(r.h5,{id:"timertaskscheduler",children:(0,n.jsx)(r.code,{children:"timerTaskScheduler"})}),"\n",(0,n.jsxs)(r.p,{children:["Dedicated to all tasks that involve delays, or other time-sensitive operations. This means ",(0,n.jsx)(r.strong,{children:"blocking"})," is forbidden under these schedulers. Defaults to a parallel scheduler named ",(0,n.jsx)(r.code,{children:"d4j-parallel-N"})," and will throw an exception if running blocking code on it."]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"Delaying Gateway identify attempts"}),"\n",(0,n.jsx)(r.li,{children:"Delaying outbound Gateway payloads under per-session rate limit"}),"\n",(0,n.jsx)(r.li,{children:"Scheduling Gateway periodic heartbeat"}),"\n",(0,n.jsx)(r.li,{children:"Delaying REST API requests under Discord global rate limit"}),"\n",(0,n.jsx)(r.li,{children:"Delaying REST API requests under Discord per-bucket rate limit"}),"\n",(0,n.jsx)(r.li,{children:"Scheduling Voice Gateway periodic heartbeat"}),"\n",(0,n.jsx)(r.li,{children:"Delaying connection attempts for Gateway and Voice Gateway"}),"\n"]}),"\n",(0,n.jsx)(r.h5,{id:"blockingtaskscheduler",children:(0,n.jsx)(r.code,{children:"blockingTaskScheduler"})}),"\n",(0,n.jsxs)(r.p,{children:["Dedicated to all tasks where ",(0,n.jsx)(r.strong,{children:"blocking"})," is possible. Defaults to Reactor global ",(0,n.jsx)(r.code,{children:"boundedElastic"})," scheduler."]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Scheduling early event listeners registered through ",(0,n.jsx)(r.code,{children:"GatewayBootstrap::withEventDispatcher"})]}),"\n",(0,n.jsx)(r.li,{children:"Publishing responses from the REST API operations"}),"\n"]}),"\n",(0,n.jsx)(r.h4,{id:"specific-resources-for-gateway-and-voice",children:"Specific resources for Gateway and Voice"}),"\n",(0,n.jsxs)(r.p,{children:["A ",(0,n.jsx)(r.code,{children:"ReactorResources"})," instance will be used for REST API operations, and reused for Gateway and Voice operations, ",(0,n.jsx)(r.strong,{children:"unless"})," overridden by the user."]}),"\n",(0,n.jsx)(r.p,{children:"You can customize the resources used exclusively for Gateway through the bootstrap:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'GatewayDiscordClient client = DiscordClient.create("TOKEN")\r\n    .gateway()\r\n    .setGatewayReactorResources(reactorResources -> new GatewayReactorResources(...))\r\n    .login()\r\n    .block();\n'})}),"\n",(0,n.jsxs)(r.p,{children:["A ",(0,n.jsx)(r.code,{children:"GatewayReactorResources"})," has an extra scheduler for dedicated Gateway payload sending. If not overridden, it will use a dedicated single scheduler called ",(0,n.jsx)(r.code,{children:"d4j-gateway"}),". Can be created through ",(0,n.jsx)(r.code,{children:"GatewayReactorResources::DEFAULT_PAYLOAD_SENDER_SCHEDULER"}),"."]}),"\n",(0,n.jsx)(r.p,{children:"The same can be done for voice:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'GatewayDiscordClient client = DiscordClient.create("TOKEN")\r\n    .gateway()\r\n    .setVoiceReactorResources(reactorResources -> new VoiceReactorResources(...))\r\n    .login()\r\n    .block();\n'})}),"\n",(0,n.jsxs)(r.p,{children:["A ",(0,n.jsx)(r.code,{children:"VoiceGatewayResources"})," requires extra parameters due to all concurrent tasks it needs to keep. Among them:"]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Scheduling Voice send task (defaults to ",(0,n.jsx)(r.code,{children:"timerTaskScheduler"})," if not replaced)"]}),"\n",(0,n.jsxs)(r.li,{children:["Scheduling Voice receive task (defaults to ",(0,n.jsx)(r.code,{children:"timerTaskScheduler"})," if not replaced)"]}),"\n"]}),"\n",(0,n.jsx)(r.h3,{id:"eventdispatcher",children:"EventDispatcher"}),"\n",(0,n.jsxs)(r.p,{children:["The ",(0,n.jsx)(r.code,{children:"EventDispatcher"})," is a key element in the Discord4J Core architecture. Since v3.1.0 a wide range of customization is possible on this component, in particular: the backing Processor, its back-pressure (flow control) strategy, and the Scheduler used for publishing events."]}),"\n",(0,n.jsx)(r.h4,{id:"replacing-thread-model",children:"Replacing thread model"}),"\n",(0,n.jsxs)(r.p,{children:["Acquire a builder using ",(0,n.jsx)(r.code,{children:"EventDispatcher::builder"})," and customize its scheduler using ",(0,n.jsx)(r.code,{children:"eventScheduler"}),":"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"EventDispatcher customDispatcher = EventDispatcher.builder()\r\n    .eventScheduler(Schedulers.boundedElastic())\r\n    .build();\n"})}),"\n",(0,n.jsxs)(r.p,{children:["The current default is creating a ",(0,n.jsx)(r.code,{children:"ForkJoinPool"}),"-based scheduler called ",(0,n.jsx)(r.code,{children:"d4j-events"}),". If you decide to change it, these are our recommendations:"]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["If you perform a lot of blocking and slow operations, switch to ",(0,n.jsx)(r.code,{children:"Schedulers.boundedElastic()"}),"."]}),"\n",(0,n.jsxs)(r.li,{children:["If you ",(0,n.jsx)(r.strong,{children:"never"})," call block, perform operations that park threads like blocking HTTP libraries nor blocking I/O in general, try using ",(0,n.jsx)(r.code,{children:"Schedulers.immediate()"})," to minimize thread switching."]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,r,s)=>{s.d(r,{R:()=>c,x:()=>o});var n=s(6540);const i={},t=n.createContext(i);function c(e){const r=n.useContext(t);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),n.createElement(t.Provider,{value:r},e.children)}}}]);